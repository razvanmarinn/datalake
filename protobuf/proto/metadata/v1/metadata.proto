syntax = "proto3";
package metadata.v1;

option go_package = "github.com/razvanmarinn/datalake/protobuf/gen/go/metadata/v1;metadatav1";

import "google/protobuf/timestamp.proto";

service MetadataService {
    rpc VerifyProjectExistence(VerifyProjectExistenceRequest) returns (VerifyProjectExistenceResponse);
    rpc GetCompactionJob(GetCompactionJobRequest) returns (GetCompactionJobResponse);
    
    rpc UpdateCompactionJobStatus(UpdateCompactionJobStatusRequest) returns (UpdateCompactionJobStatusResponse);
    
    rpc RegisterBlockForCompaction(RegisterBlockForCompactionRequest) returns (RegisterBlockForCompactionResponse);
    
    rpc GetBlockLocations(GetBlockLocationsRequest) returns (GetBlockLocationsResponse);
}

message VerifyProjectExistenceRequest {
    string project_name = 1;
}
message VerifyProjectExistenceResponse {
    bool exists = 1;
}


message CompactionJob {
    string id = 1;
    string project_id = 2;
    string schema_name = 3;
    string status = 4; 
    repeated string target_block_ids = 5;
    string output_file_path = 6;
    google.protobuf.Timestamp created_at = 7;
    google.protobuf.Timestamp updated_at = 8;
}

message GetCompactionJobRequest {
    string project_id = 1;
    string schema_name = 2;
}

message GetCompactionJobResponse {
    CompactionJob job = 1;
}

message UpdateCompactionJobStatusRequest {
    string job_id = 1;
    string status = 2; 
    string output_file_path = 3; 
    repeated string compacted_block_ids = 4; 
}

message UpdateCompactionJobStatusResponse {
    bool success = 1;
    string message = 2;
}

// RENAMED: RegisterBlockRequest -> RegisterBlockForCompactionRequest
message RegisterBlockForCompactionRequest {
    string project_id = 1;
    string schema_name = 2;
    string block_id = 3;
    string worker_id = 4;
    string path = 5;
    int64 size = 6;
    string format = 7; 
}

message RegisterBlockForCompactionResponse {
    bool success = 1;
    string message = 2;
}

message MetadataBlockLocation {
    string block_id = 1;
    string worker_id = 2;
    string path = 3;
}

message GetBlockLocationsRequest {
    repeated string block_ids = 1;
}

message GetBlockLocationsResponse {
    repeated MetadataBlockLocation locations = 1;
}